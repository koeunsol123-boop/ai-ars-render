<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        text-align: center;
        padding: 30px;
        background: #f4f6f9;
      }
      h2 {
        color: #1a73e8;
        margin-bottom: 10px;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background-color: #1976d2;
        color: white;
        cursor: pointer;
        font-size: 15px;
      }
      button:hover {
        background-color: #135ba1;
      }
      #log {
        margin-top: 30px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        width: 70%;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        font-family: monospace;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #menu {
        display: none;
        margin-top: 15px;
      }
    </style>
  </head>

  <body>
    <h2>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</h2>
    <p>
      ë¨¼ì € â€˜ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒâ€™ì„ ëˆŒëŸ¬ ì´ˆê¸° ìŒì„±ì„ ë“¤ì€ ë’¤,<br />
      ì‹ ê³  ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </p>

    <div>
      <button onclick="playIntro()">â‘  ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ</button>
      <div id="menu">
        <button onclick="startCall('fake')">ê°€ì§œì„ìœ  ì‹ ê³ </button>
        <button onclick="startCall('mixed')">í˜¼í•©ìœ  ì‹ ê³ </button>
        <button onclick="startCall('station')">ì£¼ìœ ì†Œ ê°œÂ·íì—… ì‹ ê³ </button>
      </div>
      <button onclick="endCall()">ì¢…ë£Œ</button>
      <button onclick="downloadLog()">ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="recordingControls" style="margin-top: 20px; display: none;">
      <h3>ğŸ™ï¸ ë‹´ë‹¹ì ë¶€ì¬ì¤‘ ë…¹ìŒ</h3>
      <button id="btn-record">ë…¹ìŒ ì‹œì‘</button>
      <button id="btn-stop" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
      <button id="btn-play" disabled>â–¶ï¸ ì¬ìƒ</button>
    </div>

    <h3>ë¡œê·¸</h3>
    <div id="log"></div>

    <script>
      let mediaRecorder;
      let micStream;
      let recordedChunks = [];
      let logs = [];

      // ğŸ§ ì¬ìƒ ì¤‘ì¸ ì˜¤ë””ì˜¤, ì˜ˆì•½ëœ íƒ€ì´ë¨¸, ì¢…ë£Œ ìƒíƒœ í”Œë˜ê·¸
      let activeAudios = [];
      let timers = [];
      let isEnded = false;

      function log(msg) {
        const time = new Date().toLocaleTimeString();
        const entry = `[${time}] ${msg}`;
        logs.push(entry);
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += entry + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // âœ… íƒ€ì´ë¨¸ ë“±ë¡ (ì¢…ë£Œ í›„ ì‹¤í–‰ ë°©ì§€)
      function setGuardedTimeout(fn, ms) {
        const id = setTimeout(() => {
          if (isEnded) return;
          fn();
        }, ms);
        timers.push(id);
        return id;
      }

      // âœ… ì˜¤ë””ì˜¤ ì¬ìƒ
      function playAudio(src, callback) {
        if (isEnded) return;
        const audio = new Audio(src);
        activeAudios.push(audio);
        audio.play().catch(() => {});
        audio.onended = () => {
          activeAudios = activeAudios.filter((a) => a !== audio);
          if (!isEnded && callback) callback();
        };
        return audio;
      }

      // ğŸ—£ï¸ ì•ˆë‚´ ë©˜íŠ¸
      function playIntro() {
        isEnded = false;
        log("ğŸ—£ï¸ ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ ì‹œì‘");
        playAudio("intro.mp3", () => {
          log("âœ… ì•ˆë‚´ ë©˜íŠ¸ ì¢…ë£Œ â†’ ë©”ë‰´ í‘œì‹œ");
          document.getElementById("menu").style.display = "block";
        });
      }

      // ğŸ“ ì‹ ê³  ì„ íƒ ì‹œ íë¦„
      function startCall(type) {
        isEnded = false;
        log(`ğŸ“ ${type} ì‹ ê³  í†µí™” ì‹œì‘`);

        playAudio(`${type}.mp3`, () => {
          log("ğŸ”Š ë‹´ë‹¹ì ë©˜íŠ¸ ì¬ìƒ ì™„ë£Œ â†’ ì—°ê²°ìŒ ì¬ìƒ (3ì´ˆ)");
          const ring = playAudio("ring.mp3");

          setGuardedTimeout(() => {
            if (ring) {
              ring.pause();
              ring.currentTime = 0;
              activeAudios = activeAudios.filter((a) => a !== ring);
            }
            log("â±ï¸ 3ì´ˆ í›„ ë¶€ì¬ì¤‘ ì•ˆë‚´ ì¬ìƒ");
            setGuardedTimeout(() => {
              playAudio("unavailable.mp3", () => {
                log("ğŸ™ï¸ ë‹´ë‹¹ì ë¶€ì¬ì¤‘ ì•ˆë‚´ ì¢…ë£Œ â†’ ë…¹ìŒë²„íŠ¼ í‘œì‹œ");
                if (!isEnded) {
                  document.getElementById("recordingControls").style.display = "block";
                }
              });
            }, 3000);
          }, 3000);
        });
      }

      // ğŸ›‘ ì¢…ë£Œ: ëª¨ë“  ì˜¤ë””ì˜¤Â·íƒ€ì´ë¨¸Â·ë…¹ìŒ ì¦‰ì‹œ ì¤‘ë‹¨
      function endCall() {
        isEnded = true;
        timers.forEach((id) => clearTimeout(id));
        timers = [];

        activeAudios.forEach((a) => {
          try {
            a.pause();
            a.currentTime = 0;
          } catch {}
        });
        activeAudios = [];

        try {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
          if (micStream) {
            micStream.getTracks().forEach((t) => t.stop());
            micStream = null;
          }
        } catch {}

        playAudio("end.mp3");
        log("ğŸ›‘ í†µí™” ì¢…ë£Œ (ëª¨ë“  ì˜¤ë””ì˜¤Â·íƒ€ì´ë¨¸Â·ë…¹ìŒ ì¦‰ì‹œ ì¤‘ë‹¨)");
      }

      // ğŸ™ï¸ ë…¹ìŒ ê¸°ëŠ¥
      const btnRecord = document.getElementById("btn-record");
      const btnStop = document.getElementById("btn-stop");
      const btnPlay = document.getElementById("btn-play");

      btnRecord.onclick = async () => {
        isEnded = false;
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(micStream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          btnPlay.onclick = () => new Audio(url).play();
          btnPlay.disabled = false;
          log("âœ… ë…¹ìŒ ì™„ë£Œ (ì¬ìƒ ê°€ëŠ¥)");
        };

        mediaRecorder.start();
        btnRecord.disabled = true;
        btnStop.disabled = false;
        log("ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ë¨");
      };

      btnStop.onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
        if (micStream) {
          micStream.getTracks().forEach((t) => t.stop());
          micStream = null;
        }
        btnStop.disabled = true;
        btnRecord.disabled = false;
        log("â¹ï¸ ë…¹ìŒ ì¤‘ì§€ë¨");
      };

      // ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
      function downloadLog() {
        const blob = new Blob([logs.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const now = new Date().toISOString().split("T")[0];
        a.download = `ARS_ë¡œê·¸_${now}.txt`;
        a.click();
        log("ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
      }
    </script>
  </body>
</html>
