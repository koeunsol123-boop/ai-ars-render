<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        text-align: center;
        padding: 30px;
        background: #f4f6f9;
      }
      h2 {
        color: #1a73e8;
        margin-bottom: 10px;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background-color: #1976d2;
        color: white;
        cursor: pointer;
        font-size: 15px;
      }
      button:hover {
        background-color: #135ba1;
      }
      #log {
        margin-top: 30px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        width: 70%;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        font-family: monospace;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #menu {
        display: none;
        margin-top: 15px;
      }
      #recordingControls {
        margin-top: 20px;
        display: none;
      }
    </style>
  </head>

  <body>
    <h2>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</h2>
    <p>
      ë¨¼ì € â€˜ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒâ€™ì„ ëˆŒëŸ¬ ì´ˆê¸° ìŒì„±ì„ ë“¤ì€ ë’¤,<br />
      ì‹ ê³  ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </p>

    <div>
      <button onclick="initAudio()">â‘  ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ</button>
      <div id="menu">
        <button onclick="startCall('fake')">ê°€ì§œì„ìœ  ì‹ ê³ </button>
        <button onclick="startCall('mixed')">í˜¼í•©ìœ  ì‹ ê³ </button>
        <button onclick="startCall('station')">ì¼ë°˜ëŒ€ë¦¬ì  ë“±ë¡Â·ë³€ê²½ ì ‘ìˆ˜</button>
        <button onclick="startCall('agency_close')">ì¼ë°˜ëŒ€ë¦¬ì  ê°œì‹œÂ·íœ´ì—…Â·íì—… ì‹ ê³ </button>
      </div>
      <button onclick="endCall()">ì¢…ë£Œ</button>
      <button onclick="downloadLog()">ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="recordingControls">
      <h3>ğŸ™ï¸ ë‹´ë‹¹ì ë¶€ì¬ì¤‘ ë…¹ìŒ</h3>
      <button id="btn-record">ë…¹ìŒ ì‹œì‘</button>
      <button id="btn-stop" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
      <button id="btn-play" disabled>â–¶ï¸ ì¬ìƒ</button>
      <button id="btn-save" disabled>ğŸ’¾ ë…¹ìŒ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <h3>ë¡œê·¸</h3>
    <div id="log"></div>

    <script>
      let audioEnabled = false;
      let audioContext;
      let callTimer;
      let mediaRecorder;
      let recordedChunks = [];
      let logs = [];

      const audios = {
        intro: new Audio("/intro.mp3"),
        fake: new Audio("/fake.mp3"),
        mixed: new Audio("/mixed.mp3"),
        station: new Audio("/station.mp3"),
        agency_close: new Audio("/agency_close.mp3"),
        ring: new Audio("/ring.mp3"),
        unavailable: new Audio("/unavailable.mp3"),
        end: new Audio("/end.mp3"),
      };

      function log(msg) {
        const time = new Date().toLocaleTimeString();
        const entry = `[${time}] ${msg}`;
        logs.push(entry);
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += entry + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function activateAudio() {
        if (!audioContext)
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.resume();
      }

      function stopAllAudio() {
        Object.values(audios).forEach((a) => {
          a.pause();
          a.currentTime = 0;
        });
        clearTimeout(callTimer);
      }

      function playAudio(name, callback) {
        stopAllAudio();
        activateAudio();

        const audio = audios[name];
        if (!audio) return;
        audio.currentTime = 0;
        audio.play().catch(() => {
          log(`âš ï¸ ${name} ì¬ìƒ ì°¨ë‹¨ë¨ (iOS ê¶Œí•œ í•„ìš”)`);
        });
        if (callback) audio.onended = callback;
      }

      function initAudio() {
        if (!audioEnabled) {
          activateAudio();
          audioEnabled = true;
          log("ğŸ”Š ì˜¤ë””ì˜¤ ê¶Œí•œ í™œì„±í™”ë¨");
          playIntro();
        } else {
          playIntro();
        }
      }

      function playIntro() {
        stopAllAudio();
        log("ğŸ—£ï¸ ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ");
        playAudio("intro", () => {
          log("âœ… ì•ˆë‚´ ë©˜íŠ¸ ì¢…ë£Œ â†’ ë©”ë‰´ í‘œì‹œ");
          document.getElementById("menu").style.display = "block";
        });
      }

      function startCall(type) {
        if (!audioEnabled) {
          activateAudio();
          audioEnabled = true;
          log("ğŸ”Š ì˜¤ë””ì˜¤ ê¶Œí•œ ìë™ í™œì„±í™”ë¨");
        }

        stopAllAudio();
        log(`ğŸ“ ${type} ì‹ ê³  í†µí™” ì‹œì‘`);
        playAudio(type, () => {
          log("ğŸ”Š ë‹´ë‹¹ì ë©˜íŠ¸ ì™„ë£Œ â†’ ì—°ê²°ìŒ 3ì´ˆ");
          playAudio("ring");
          callTimer = setTimeout(() => {
            stopAllAudio();
            playAudio("unavailable", () => {
              log("ğŸ™ï¸ ë¶€ì¬ì¤‘ ì•ˆë‚´ ì¢…ë£Œ â†’ ë…¹ìŒë²„íŠ¼ í‘œì‹œ");
              document.getElementById("recordingControls").style.display = "block";
            });
          }, 3000);
        });
      }

      function endCall() {
        stopAllAudio();
        log("ğŸ›‘ í†µí™” ì¢…ë£Œ â†’ ì¢…ë£Œ ë©˜íŠ¸ ì¬ìƒ");
        playAudio("end");
      }

      const btnRecord = document.getElementById("btn-record");
      const btnStop = document.getElementById("btn-stop");
      const btnPlay = document.getElementById("btn-play");
      const btnSave = document.getElementById("btn-save");

      btnRecord.onclick = async () => {
        log("ğŸ™ï¸ ë…¹ìŒ ê¶Œí•œ ìš”ì²­");
        const stream = await navigator.mediaDevices
          .getUserMedia({ audio: true })
          .catch(() => {
            log("ğŸš« ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨");
          });
        if (!stream) return;

        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          btnPlay.onclick = () => new Audio(url).play();
          btnPlay.disabled = false;
          btnSave.disabled = false;
          btnSave.onclick = () => {
            const a = document.createElement("a");
            a.href = url;
            a.download = `ARS_ë…¹ìŒ_${new Date().toISOString().split("T")[0]}.webm`;
            a.click();
            log("ğŸ’¾ ë…¹ìŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¨");
          };
          log("âœ… ë…¹ìŒ ì™„ë£Œ (ì¬ìƒ ë° ì €ì¥ ê°€ëŠ¥)");
        };

        mediaRecorder.start();
        btnRecord.disabled = true;
        btnStop.disabled = false;
        log("ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ë¨");
      };

      btnStop.onclick = () => {
        mediaRecorder.stop();
        btnStop.disabled = true;
        btnRecord.disabled = false;
        log("â¹ï¸ ë…¹ìŒ ì¤‘ì§€ë¨");
      };

      function downloadLog() {
        const blob = new Blob([logs.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const now = new Date().toISOString().split("T")[0];
        a.download = `ARS_ë¡œê·¸_${now}.txt`;
        a.click();
        log("ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
      }
    </script>
  </body>
</html>
