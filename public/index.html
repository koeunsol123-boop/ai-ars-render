<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        text-align: center;
        padding: 30px;
        background: #f4f6f9;
      }
      h2 {
        color: #1a73e8;
        margin-bottom: 10px;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background-color: #1976d2;
        color: white;
        cursor: pointer;
        font-size: 15px;
      }
      button:hover {
        background-color: #135ba1;
      }
      #log {
        margin-top: 30px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        width: 70%;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        font-family: monospace;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #menu {
        display: none;
        margin-top: 15px;
      }
      #recordingControls {
        margin-top: 20px;
        display: none;
      }
    </style>
  </head>

  <body>
    <h2>AI ARS ì‹œì—° ì‹œìŠ¤í…œ</h2>
    <p>
      ë¨¼ì € â€˜ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒâ€™ì„ ëˆŒëŸ¬ ì´ˆê¸° ìŒì„±ì„ ë“¤ì€ ë’¤,<br />
      ì‹ ê³  ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </p>

    <div>
      <button onclick="initAudio()">â‘  ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ</button>
      <div id="menu">
        <button onclick="startCall('fake')">ê°€ì§œì„ìœ  ì‹ ê³ </button>
        <button onclick="startCall('mixed')">í˜¼í•©ìœ  ì‹ ê³ </button>
        <button onclick="startCall('station')">ì£¼ìœ ì†Œ ê°œÂ·íì—… ì‹ ê³ </button>
      </div>
      <button onclick="endCall()">ì¢…ë£Œ</button>
      <button onclick="downloadLog()">ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="recordingControls">
      <h3>ğŸ™ï¸ ë‹´ë‹¹ì ë¶€ì¬ì¤‘ ë…¹ìŒ</h3>
      <button id="btn-record">ë…¹ìŒ ì‹œì‘</button>
      <button id="btn-stop" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
      <button id="btn-play" disabled>â–¶ï¸ ì¬ìƒ</button>
    </div>

    <h3>ë¡œê·¸</h3>
    <div id="log"></div>

    <script>
      let audioEnabled = false;
      let audioContext;
      let callTimer;
      let mediaRecorder;
      let recordedChunks = [];
      let logs = [];

      // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
      function log(msg) {
        const time = new Date().toLocaleTimeString();
        const entry = `[${time}] ${msg}`;
        logs.push(entry);
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += entry + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // ì˜¤ë””ì˜¤ ë¯¸ë¦¬ ë¡œë“œ (iOS ì§€ì—° ë°©ì§€)
      function preloadAudios() {
        const files = [
          "/intro.mp3",
          "/fake.mp3",
          "/mixed.mp3",
          "/station.mp3",
          "/ring.mp3",
          "/unavailable.mp3",
          "/end.mp3",
        ];
        files.forEach((src) => {
          const a = new Audio(src);
          a.load();
        });
      }

      // ì˜¤ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜
      function playAudio(src, callback) {
        const audio = new Audio(src);
        audio.play().catch(() => {
          log("âš ï¸ iOS ìë™ì¬ìƒ ì°¨ë‹¨ë¨ â€” ë°˜ë“œì‹œ í„°ì¹˜ í›„ ì‹¤í–‰ í•„ìš”");
        });
        if (callback) audio.onended = callback;
      }

      // iOSìš© ì˜¤ë””ì˜¤ ê¶Œí•œ ì´ˆê¸°í™”
      function initAudio() {
        if (!audioEnabled) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          audioContext.resume().then(() => {
            preloadAudios();
            log("ğŸ”Š ì˜¤ë””ì˜¤ ê¶Œí•œ í™œì„±í™”ë¨ (iOS Safari í¬í•¨)");
            audioEnabled = true;
            playIntro();
          });
        } else {
          playIntro();
        }
      }

      // ì•ˆë‚´ë©˜íŠ¸
      function playIntro() {
        log("ğŸ—£ï¸ ì•ˆë‚´ ë©˜íŠ¸ ì¬ìƒ");
        playAudio("/intro.mp3", () => {
          log("âœ… ì•ˆë‚´ ë©˜íŠ¸ ì¢…ë£Œ â†’ ë©”ë‰´ í‘œì‹œ");
          document.getElementById("menu").style.display = "block";
        });
      }

      // ì‹ ê³ ìœ í˜• ì„ íƒ â†’ ë‹´ë‹¹ìë©˜íŠ¸ â†’ ì—°ê²°ìŒ â†’ ë¶€ì¬ì¤‘ë©˜íŠ¸
      function startCall(type) {
        log(`ğŸ“ ${type} ì‹ ê³  í†µí™” ì‹œì‘`);
        playAudio(`/${type}.mp3`, () => {
          log("ğŸ”Š ë‹´ë‹¹ì ë©˜íŠ¸ ì¬ìƒ ì™„ë£Œ â†’ ì—°ê²°ìŒ ì¬ìƒ (3ì´ˆ)");
          const ring = new Audio("/ring.mp3");
          ring.play();

          setTimeout(() => {
            ring.pause();
            ring.currentTime = 0;
            log("â±ï¸ 3ì´ˆ í›„ ë¶€ì¬ì¤‘ ì•ˆë‚´ ì¬ìƒ");
            playAudio("/unavailable.mp3", () => {
              log("ğŸ™ï¸ ë¶€ì¬ì¤‘ ì•ˆë‚´ ì¢…ë£Œ â†’ ë…¹ìŒ ë²„íŠ¼ í‘œì‹œ");
              document.getElementById("recordingControls").style.display = "block";
            });
          }, 3000);
        });
      }

      // ì¢…ë£Œ ë²„íŠ¼ â†’ ì˜¤ë””ì˜¤ ëª¨ë‘ ì¤‘ì§€ í›„ ì¢…ë£Œë©˜íŠ¸
      function endCall() {
        log("ğŸ›‘ í†µí™” ì¢…ë£Œ");
        clearTimeout(callTimer);
        document.querySelectorAll("audio").forEach((a) => {
          try {
            a.pause();
            a.currentTime = 0;
          } catch (e) {}
        });
        playAudio("/end.mp3");
      }

      // ë…¹ìŒ ê¸°ëŠ¥
      const btnRecord = document.getElementById("btn-record");
      const btnStop = document.getElementById("btn-stop");
      const btnPlay = document.getElementById("btn-play");

      btnRecord.onclick = async () => {
        log("ğŸ™ï¸ ë…¹ìŒ ê¶Œí•œ ìš”ì²­");
        const stream = await navigator.mediaDevices
          .getUserMedia({ audio: true })
          .catch(() => {
            log("ğŸš« ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨");
          });
        if (!stream) return;

        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          btnPlay.onclick = () => new Audio(url).play();
          btnPlay.disabled = false;
          log("âœ… ë…¹ìŒ ì™„ë£Œ (ì¬ìƒ ê°€ëŠ¥)");
        };

        mediaRecorder.start();
        btnRecord.disabled = true;
        btnStop.disabled = false;
        log("ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ë¨");
      };

      btnStop.onclick = () => {
        mediaRecorder.stop();
        btnStop.disabled = true;
        btnRecord.disabled = false;
        log("â¹ï¸ ë…¹ìŒ ì¤‘ì§€ë¨");
      };

      // ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
      function downloadLog() {
        const blob = new Blob([logs.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const now = new Date().toISOString().split("T")[0];
        a.download = `ARS_ë¡œê·¸_${now}.txt`;
        a.click();
        log("ğŸ“„ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");
      }
    </script>
  </body>
</html>
